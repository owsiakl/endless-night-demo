!function(){"use strict";class t{constructor(t,e,s,r,i,n){this.bufferView=t,this.buffer=e,this.byteOffset=s,this.componentType=r,this.count=i,this.type=n}static fromJson(t,e,s){const r=e[t.bufferView];return new this(r,s[r.buffer],t.byteOffset??0,t.componentType,t.count,t.type)}get data(){const t=this.bufferView,e=this.buffer,s=this.typedArray;if(t.isInterleaved){const r=new s(e.arrayBuffer(),t.byteOffset+this.byteOffset),i=new s(this.length),n=t.byteStride/s.BYTES_PER_ELEMENT;for(let t=0;t<this.count;t++){const e=n*t,s=e+this.typeSize;i.set(r.slice(e,s),t*this.typeSize)}return new s(i,t.byteOffset+this.byteOffset)}return new s(e.arrayBuffer(),t.byteOffset+this.byteOffset,this.count*this.typeSize)}get typeSize(){switch(this.type){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:throw new Error(`Can't get typed size based on "${this.type}" type`)}}get typedArray(){switch(this.componentType){case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`Can't get typed array based on "${this.componentType}" type`)}}get length(){return this.count*this.typeSize}}class e{constructor(t,e,s,r,i){this.buffer=t,this.byteOffset=e,this.byteLength=s,this.byteStride=r,this.target=i}static fromJson(t){return new this(t.buffer,t.byteOffset??0,t.byteLength,t.byteStride??0,t.target??null)}get isInterleaved(){return this.byteStride>0}}class s{constructor(t,e){this._uri=t,this._byteLength=e,this._arrayBufferCache=null}static async fromJson(t){const e=new this(t.uri,t.byteLength);if(void 0!==t.binary)e._arrayBufferCache=t.binary;else if(!e._uri.startsWith("data:")){const t=await fetch("/model/"+e._uri);e._arrayBufferCache=await t.arrayBuffer()}return e}arrayBuffer(){if(null!==this._arrayBufferCache)return this._arrayBufferCache;if(!this._uri.startsWith("data:"))throw new Error("GLTF buffer URIs other than data are not implemented.");const t=this._uri.indexOf(","),[e,s]=this._uri.substring(5,t).split(";");if(!["application/octet-stream","application/gltf-buffer"].includes(e))throw new Error(`GLTF buffer data URIs "${e}" mime type is not supported.`);if(!["base64"].includes(s))throw new Error(`GLTF buffer data URIs "${s}" encoding is not supported.`);const r=this._uri.substring(t+1),i=atob(r),n=new ArrayBuffer(i.length),a=new Uint8Array(n);for(let t=0;t<i.length;t++)a[t]=i.charCodeAt(t);return n}}var r=1e-6,i="undefined"!=typeof Float32Array?Float32Array:Array;function n(){var t=new i(16);return i!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function a(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function o(t,e,s){var r=e[0],i=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],_=e[9],f=e[10],d=e[11],m=e[12],p=e[13],g=e[14],T=e[15],E=s[0],w=s[1],b=s[2],v=s[3];return t[0]=E*r+w*o+b*c+v*m,t[1]=E*i+w*h+b*_+v*p,t[2]=E*n+w*l+b*f+v*g,t[3]=E*a+w*u+b*d+v*T,E=s[4],w=s[5],b=s[6],v=s[7],t[4]=E*r+w*o+b*c+v*m,t[5]=E*i+w*h+b*_+v*p,t[6]=E*n+w*l+b*f+v*g,t[7]=E*a+w*u+b*d+v*T,E=s[8],w=s[9],b=s[10],v=s[11],t[8]=E*r+w*o+b*c+v*m,t[9]=E*i+w*h+b*_+v*p,t[10]=E*n+w*l+b*f+v*g,t[11]=E*a+w*u+b*d+v*T,E=s[12],w=s[13],b=s[14],v=s[15],t[12]=E*r+w*o+b*c+v*m,t[13]=E*i+w*h+b*_+v*p,t[14]=E*n+w*l+b*f+v*g,t[15]=E*a+w*u+b*d+v*T,t}function h(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function l(t,e){var s=e[0],r=e[1],i=e[2],n=e[4],a=e[5],o=e[6],h=e[8],l=e[9],u=e[10];return t[0]=Math.hypot(s,r,i),t[1]=Math.hypot(n,a,o),t[2]=Math.hypot(h,l,u),t}function u(t,e){var s=new i(3);l(s,e);var r=1/s[0],n=1/s[1],a=1/s[2],o=e[0]*r,h=e[1]*n,u=e[2]*a,c=e[4]*r,_=e[5]*n,f=e[6]*a,d=e[8]*r,m=e[9]*n,p=e[10]*a,g=o+_+p,T=0;return g>0?(T=2*Math.sqrt(g+1),t[3]=.25*T,t[0]=(f-m)/T,t[1]=(d-u)/T,t[2]=(h-c)/T):o>_&&o>p?(T=2*Math.sqrt(1+o-_-p),t[3]=(f-m)/T,t[0]=.25*T,t[1]=(h+c)/T,t[2]=(d+u)/T):_>p?(T=2*Math.sqrt(1+_-o-p),t[3]=(d-u)/T,t[0]=(h+c)/T,t[1]=.25*T,t[2]=(f+m)/T):(T=2*Math.sqrt(1+p-o-_),t[3]=(h-c)/T,t[0]=(d+u)/T,t[1]=(f+m)/T,t[2]=.25*T),t}function c(t,e,s,r){var i=e[0],n=e[1],a=e[2],o=e[3],h=i+i,l=n+n,u=a+a,c=i*h,_=i*l,f=i*u,d=n*l,m=n*u,p=a*u,g=o*h,T=o*l,E=o*u,w=r[0],b=r[1],v=r[2];return t[0]=(1-(d+p))*w,t[1]=(_+E)*w,t[2]=(f-T)*w,t[3]=0,t[4]=(_-E)*b,t[5]=(1-(c+p))*b,t[6]=(m+g)*b,t[7]=0,t[8]=(f+T)*v,t[9]=(m-g)*v,t[10]=(1-(c+d))*v,t[11]=0,t[12]=s[0],t[13]=s[1],t[14]=s[2],t[15]=1,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var _=function(t,e,s,r,i){var n,a=1/Math.tan(e/2);return t[0]=a/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(n=1/(r-i),t[10]=(i+r)*n,t[14]=2*i*r*n):(t[10]=-1,t[14]=-2*r),t};function f(t,e,s,i){var n,a,o,h,l,u,c,_,f,d,m=e[0],p=e[1],g=e[2],T=i[0],E=i[1],w=i[2],b=s[0],v=s[1],M=s[2];return Math.abs(m-b)<r&&Math.abs(p-v)<r&&Math.abs(g-M)<r?function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t):(c=m-b,_=p-v,f=g-M,n=E*(f*=d=1/Math.hypot(c,_,f))-w*(_*=d),a=w*(c*=d)-T*f,o=T*_-E*c,(d=Math.hypot(n,a,o))?(n*=d=1/d,a*=d,o*=d):(n=0,a=0,o=0),h=_*o-f*a,l=f*n-c*o,u=c*a-_*n,(d=Math.hypot(h,l,u))?(h*=d=1/d,l*=d,u*=d):(h=0,l=0,u=0),t[0]=n,t[1]=h,t[2]=c,t[3]=0,t[4]=a,t[5]=l,t[6]=_,t[7]=0,t[8]=o,t[9]=u,t[10]=f,t[11]=0,t[12]=-(n*m+a*p+o*g),t[13]=-(h*m+l*p+u*g),t[14]=-(c*m+_*p+f*g),t[15]=1,t)}function d(){var t=new i(3);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function m(t){var e=t[0],s=t[1],r=t[2];return Math.hypot(e,s,r)}function p(t,e,s){var r=new i(3);return r[0]=t,r[1]=e,r[2]=s,r}function g(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t}function T(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t}function E(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}function w(t,e){var s=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.hypot(s,r,i)}function b(t,e){var s=e[0],r=e[1],i=e[2],n=s*s+r*r+i*i;return n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function v(t,e,s,r){var i=e[0],n=e[1],a=e[2];return t[0]=i+r*(s[0]-i),t[1]=n+r*(s[1]-n),t[2]=a+r*(s[2]-a),t}function M(t,e,s,r){var i=[],n=[];return i[0]=e[0]-s[0],i[1]=e[1]-s[1],i[2]=e[2]-s[2],n[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),n[1]=i[1],n[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=n[0]+s[0],t[1]=n[1]+s[1],t[2]=n[2]+s[2],t}function x(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function y(t,e,s){s*=.5;var r=e[0],i=e[1],n=e[2],a=e[3],o=Math.sin(s),h=Math.cos(s);return t[0]=r*h+a*o,t[1]=i*h+n*o,t[2]=n*h-i*o,t[3]=a*h-r*o,t}function A(t,e,s){s*=.5;var r=e[0],i=e[1],n=e[2],a=e[3],o=Math.sin(s),h=Math.cos(s);return t[0]=r*h-n*o,t[1]=i*h+a*o,t[2]=n*h+r*o,t[3]=a*h-i*o,t}function R(t,e,s,i){var n,a,o,h,l,u=e[0],c=e[1],_=e[2],f=e[3],d=s[0],m=s[1],p=s[2],g=s[3];return(a=u*d+c*m+_*p+f*g)<0&&(a=-a,d=-d,m=-m,p=-p,g=-g),1-a>r?(n=Math.acos(a),o=Math.sin(n),h=Math.sin((1-i)*n)/o,l=Math.sin(i*n)/o):(h=1-i,l=i),t[0]=h*u+l*d,t[1]=h*c+l*m,t[2]=h*_+l*p,t[3]=h*f+l*g,t}d(),function(){var t;t=new i(4),i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}();var C,S=function(t,e,s,r){var n=new i(4);return n[0]=t,n[1]=e,n[2]=s,n[3]=r,n};d(),p(1,0,0),p(0,1,0),x(),x(),C=new i(9),i!=Float32Array&&(C[1]=0,C[2]=0,C[3]=0,C[5]=0,C[6]=0,C[7]=0),C[0]=1,C[4]=1,C[8]=1;class P{_calculateMatrix=!1;constructor(t,e,s){this._translation=t,this._rotation=e,this._scale=s,this._matrix=c(n(),e,t,s)}static init(){return new this(p(0,0,0),S(0,0,0,1),p(1,1,1))}copy(){return new P(p(this._translation[0],this._translation[1],this._translation[2]),S(this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]),p(this._scale[0],this._scale[1],this._scale[2]))}static fromMatrix(t){return new this(h(d(),t),u(x(),t),l(d(),t))}set translation(t){this._translation=t,this._calculateMatrix=!0}get translation(){return this._translation}set rotation(t){this._rotation=t,this._calculateMatrix=!0}get rotation(){return this._rotation}set scale(t){this._scale=t,this._calculateMatrix=!0}get scale(){return this._scale}get matrix(){return this._calculateMatrix&&(this._matrix=c(n(),this._rotation,this._translation,this._scale),this._calculateMatrix=!1),this._matrix}}class U{_worldTransform=n();_localTransform=P.init();_parent=null;_children=[];set translation(t){this._localTransform.translation=t}get translation(){return this._localTransform.translation}get worldTranslation(){return h(d(),this._worldTransform)}set rotation(t){this._localTransform.rotation=t}get rotation(){return this._localTransform.rotation}set scale(t){this._localTransform.scale=t}get scale(){return this._localTransform.scale}get localTransform(){return this._localTransform}get worldTransform(){return this._worldTransform}setChild(t){t._parent=this,this._children.push(t)}traverse(t){t(this);for(let e=0,s=this._children.length;e<s;e++)this._children[e].traverse(t)}updateMatrixWorld(){this.traverse((t=>t.calculateTransforms()))}calculateTransforms(){null===this._parent?a(this._worldTransform,this._localTransform.matrix):this._worldTransform=o(n(),this._parent.worldTransform,this._localTransform.matrix)}}class I extends U{constructor(t,e){super(),this.geometry=t,this.material=e}}class L extends I{constructor(t,e){super(t,e),this.geometry=t,this.material=e,this._skeleton=null}set skeleton(t){this._skeleton=t}get skeleton(){if(null===this._skeleton)throw new Error("Skeleton for a mesh wasn't assigned yet.");return this._skeleton}}class O{static async fromJson(t,e,s){let r=null;if(void 0!==t.bufferView){const i=e[t.bufferView],n=s[i.buffer],a=new Uint8Array(n.arrayBuffer(),i.byteOffset,i.byteLength/Uint8Array.BYTES_PER_ELEMENT),o=new Blob([a],{type:t.mimeType});r=URL.createObjectURL(o)}if(void 0!==t.uri&&t.uri.startsWith("data:")&&(r=t.uri),void 0===t.uri||t.uri.startsWith("data:")||(r=`/image/${t.uri}`),null===r)throw new Error("Cannot decode gltf image uri.");return await this.resolveImage(r)}static resolveImage(t){return new Promise(((e,s)=>{const r=new globalThis.Image;r.onload=()=>e(r),r.onerror=()=>s(new Error("Cannot fetch image from file.")),r.src=t}))}}class F{constructor(){this.image=null,this.imageRepeat=!1,this.normal=null,this.normalRepeat=!1,this.color=null,this.vertexColors=!1,this.castShadow=!0,this.blending=!1}setImage(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.image=t,this.imageRepeat=e,this}setNormal(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.normal=t,this.normalRepeat=e,this}setColor(t){return this.color=t,this}disableShadows(){return this.castShadow=!1,this}useVertexColors(){return this.vertexColors=!0,this}useBlending(){return this.blending=!0,this}}class D{static fromJson(t,e){if(void 0===t)return(new F).setColor(p(.4,.4,.4));const s=t.pbrMetallicRoughness?.baseColorTexture?.index;if(void 0===s)throw new Error("Only textured material is supported now.");return(new F).setImage(e[s])}}class B{constructor(t,e,s){let r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.name=t,this.data=e,this.itemSize=s,this.normalized=r}}class N{static count=0;attributes=[];updateBuffers=!1;count=0;index=null;constructor(){this.id=N.count++}setAttribute(t,e,s){let r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.attributes.push(new B(t,e,s,r)),this.updateBuffers=!0}setEmptyAttribute(t,e,s){let r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.attributes.push(new B(t,new Float32Array(e),s,r)),this.updateBuffers=!0}get indexed(){return null!==this.index}get attributesLength(){let t=0;for(let e=0;e<this.attributes.length;e++)t+=this.attributes[e].itemSize;return t}}const j={POSITION:"position",NORMAL:"normal",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",TEXCOORD_2:"uv3",TEXCOORD_3:"uv4",TEXCOORD_4:"uv5",TEXCOORD_5:"uv6",TEXCOORD_6:"uv7",COLOR_0:"color",WEIGHTS_0:"weights",JOINTS_0:"joints"},X={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};class k{static fromJson(t,e,s){if(t.primitives.length>1)throw new Error("Mesh with multi-primitives are not supported.");const r=t.primitives[0].indices,i=t.primitives[0].attributes,n=t.primitives[0].material,a=new N;void 0!==r&&(a.index=e[r].data,a.count=a.index.length);for(const[t,s]of Object.entries(i)){const i=j[t],n=e[s];if(void 0===i||void 0===n)throw new Error(`Cannot create geometry attribute from name "${t}".`);"position"===i&&void 0===r&&(a.count=n.length/X[n.type]),a.setAttribute("a_"+i,e[s].data,X[n.type])}return new I(a,s[n])}}class V{constructor(t){this.name=t,this.tracks=[],this.startTime=1/0,this.endTime=0,this.duration=0}sample(t,e){const s=t.copy;for(let t=0;t<this.tracks.length;t++){const r=this.tracks[t].id,i=s.getLocalTransform(r),n=this.tracks[t].sample(i,e);s.setLocalTransform(r,n)}return s}recalculateDuration(){for(let t=0;t<this.tracks.length;t++)this.startTime=Math.min(this.startTime,this.tracks[t].startTime),this.endTime=Math.max(this.endTime,this.tracks[t].endTime);this.duration=this.endTime-this.startTime}}let G=function(t){return t.LINEAR="LINEAR",t.STEP="STEP",t.CUBICSPLINE="CUBICSPLINE",t}({});class H{translation=null;rotation=null;scale=null;constructor(t){this.id=t}sample(t,e){return null!==this.translation&&(t.translation=this.translation.sample(e)),null!==this.rotation&&(t.rotation=this.rotation.sample(e)),null!==this.scale&&(t.scale=this.scale.sample(e)),t}get startTime(){let t=1/0;if(null!==this.translation&&(t=Math.min(t,this.translation.startTime)),null!==this.rotation&&(t=Math.min(t,this.rotation.startTime)),null!==this.scale&&(t=Math.min(t,this.scale.startTime)),t===1/0)throw new Error("Cannot calculate start time: no available tracks.");return t}get endTime(){let t=0;if(null!==this.translation&&(t=Math.max(t,this.translation.endTime)),null!==this.rotation&&(t=Math.max(t,this.rotation.endTime)),null!==this.scale&&(t=Math.max(t,this.scale.endTime)),0===t)throw new Error("Cannot calculate end time: no available tracks.");return t}}class z{constructor(t,e){this.time=t,this.value=e}interpolate(t,e,s){if(s===G.STEP)return this.value;if(s===G.LINEAR)return v(d(),this.value,t.value,e);if(s===G.CUBICSPLINE)throw new Error("Cubic spline vector interpolation is not implemented.");throw new Error(`Unrecognized vector interpolation: "${s}".`)}}class q{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:G.LINEAR;this._frames=t,this._interpolation=e}sample(t){const e=this.getFrameIndexAt(t),s=this._frames[e],r=this._frames[e+1];if(void 0===r)throw new Error("Can't sample track: next frame doesn't exists.");const i=(t-s.time)/(r.time-s.time);return s.interpolate(r,i,this._interpolation)}get startTime(){return this._frames.reduce(((t,e)=>Math.min(t,e.time)),1/0)}get endTime(){return this._frames.reduce(((t,e)=>Math.max(t,e.time)),0)}getFrameIndexAt(t){for(let e=0;e<this._frames.length;e++)if(this._frames[e].time>=t)return Math.max(1,e)-1;throw new Error(`Can't get current frame index at time "${t}": time is out of bounds.`)}}class ${constructor(t,e){this.time=t,this.value=e}interpolate(t,e,s){if(s===G.STEP)return this.value;if(s===G.LINEAR)return R(x(),this.value,t.value,e);if(s===G.CUBICSPLINE)throw new Error("Cubic spline quaternion interpolation is not implemented.");throw new Error(`Unrecognized quaternion interpolation: "${s}".`)}}class W{static fromJson(t,e,s){const r=t.name??`animation_${e}`,i=new V(r);for(let e=0;e<t.channels.length;e++){const r=t.channels[e],n=r.target.node,a=r.target.path,o=t.samplers[r.sampler],h=s[o.input].data,l=s[o.output].data;if(void 0===n)continue;let u=G.LINEAR;if("STEP"===o.interpolation&&(u=G.STEP),"CUBICSPLINE"===o.interpolation)throw new Error("GLTF: cubic spline interpolation is not implemented.");const c=new H(n),_=l.length/h.length;if("translation"===a){const t=[];for(let e=0;e<h.length;e++)t.push(new z(h[e],l.slice(e*_,e*_+_)));c.translation=new q(t,u)}if("rotation"===a){const t=[];for(let e=0;e<h.length;e++)t.push(new $(h[e],l.slice(e*_,e*_+_)));c.rotation=new q(t,u)}if("scale"===a){const t=[];for(let e=0;e<h.length;e++)t.push(new z(h[e],l.slice(e*_,e*_+_)));c.scale=new q(t,u)}i.tracks.push(c)}return i.recalculateDuration(),i}}class Y extends U{_boneTransform=n();constructor(){super(),this._boneTransform=n()}calculateTransforms(){super.calculateTransforms(),this._parent instanceof Y?this._boneTransform=o(n(),this._parent._boneTransform,this._localTransform.matrix):a(this._boneTransform,this._localTransform.matrix)}get boneTransform(){return this._boneTransform}}class J{static fromJson(t,e,s,r){let i=new U;if(this.isBone(e,s)&&(i=new Y),this.isMesh(t)){const e=r[t.mesh];i=new I(e.geometry,e.material)}if(this.isSkinnedMesh(t)){const e=r[t.mesh];i=new L(e.geometry,e.material)}return void 0!==t.matrix&&(i.translation=h(d(),t.matrix),i.rotation=u(x(),t.matrix),i.scale=l(d(),t.matrix)),void 0!==t.translation&&(i.translation=p(...t.translation)),void 0!==t.rotation&&(i.rotation=S(...t.rotation)),void 0!==t.scale&&(i.scale=p(...t.scale)),i}static isMesh(t){return void 0!==t.mesh&&void 0===t.skin}static isSkinnedMesh(t){return void 0!==t.mesh&&void 0!==t.skin}static isBone(t,e){for(let s=0;s<e.length;s++)if(e[s].joints.includes(t))return!0;return!1}}class K{constructor(t){this.bindPose=t.copy,this.currentPose=t,this._joints=[],this._inverseBindPose=[]}getBone(t){return this._joints[t]}addJoint(t,e){this._joints.push(t),this._inverseBindPose.push(e)}get jointMatrix(){const t=this._joints.length,e=new Float32Array(16*t);for(let s=0;s<t;s++)e.set(o(n(),this._joints[s].boneTransform,this._inverseBindPose[s]),16*s);return e}get jointCount(){return this._joints.length}}class Q{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this._nodes=t,this._names=e}apply(t){for(let e=0;e<this._nodes.length;e++){const s=t._nodes[e],r=this._nodes[e];r.translation=s.translation,r.rotation=s.rotation,r.scale=s.scale}}addNode(t,e){this._nodes.push(e),this._names.push(t)}getLocalTransform(t){if(void 0===this._nodes[t])throw new Error(`Cannot get global transform for index "${t}": undefined node.`);return this._nodes[t]}setLocalTransform(t,e){this._nodes[t]=e}blendTo(t,e){const s=this.copy;for(let r=0;r<this._nodes.length;r++){const i=this._nodes[r],n=t._nodes[r];s._nodes[r]=new P(v(d(),i.translation,n.translation,e),R(x(),i.rotation,n.rotation,e),v(d(),i.scale,n.scale,e))}return s}get copy(){return new Q(this._nodes.map((t=>t.copy())),this._names.map((t=>t)))}}class Z{static fromJson(t,e,s){const r=e[t.inverseBindMatrices].data,i=new Q;for(let t=0;t<s.length;t++){s[t];const e=s[t];i.addNode(`node_${t}`,e.localTransform)}const n=new K(i);for(let e=0;e<t.joints.length;e++){const i=t.joints[e],a=r.slice(16*e,16*(e+1)),o=s[i];o instanceof Y&&n.addJoint(o,a)}return n}}class tt{constructor(t,e,s,r,i){this._defaultScene=t,this._scenes=e,this._nodes=s,this._animations=r,this._skins=i}static async parseBinary(t){const e=new Uint32Array(t,0,3);if(1179937895!==e[0])throw new Error("GLB magic number is not valid.");if(2!==e[1])throw new Error(`GLTF versions other than ${e[1]} are not implemented.`);const s=new Uint32Array(t,12,2),r=s[0];if(1313821514!==s[1])throw new Error("Unexpected GLB layout.");const i=(new TextDecoder).decode(t.slice(20,20+r)),n=JSON.parse(i);if(20+r===t.byteLength)return n;const a=new Uint32Array(t,20+r,2);if(5130562!==a[1])throw new Error("Unexpected GLB layout.");const o=20+r+8,h=a[0];return n.buffers[0].binary=t.slice(o,o+h),this.parse(n)}static async parse(r){if("2.0"!==r.asset.version)throw new Error(`GLTF versions other than ${r.asset.version} are not implemented.`);const i=r.scene??0,n=r.scenes?r.scenes.map((t=>t.nodes)):[],a=r.bufferViews?r.bufferViews.map((t=>e.fromJson(t))):[],o=r.buffers?await Promise.all(r.buffers.map((t=>s.fromJson(t)))):[],h=r.accessors?r.accessors.map((e=>t.fromJson(e,a,o))):[],l=r.images?await Promise.all(r.images.map((t=>O.fromJson(t,a,o)))):[],u=r.materials?r.materials.map((t=>D.fromJson(t,l))):[],c=r.meshes?r.meshes.map((t=>k.fromJson(t,h,u))):[],_=r.animations?r.animations.map(((t,e)=>W.fromJson(t,e,h))):[],f=r.nodes?r.nodes.map(((t,e)=>J.fromJson(t,e,r.skins??[],c))):[],d=r.skins?r.skins.map((t=>Z.fromJson(t,h,f))):[];return r.nodes?.forEach(((t,e)=>{t.children?.forEach((t=>{f[e].setChild(f[t])}))})),new this(i,n,f,_,d)}get scene(){const t=this._scenes[this._defaultScene];if(void 0===t)throw new Error(`Scene with index "${this._defaultScene}" doesn't exists.`);let e=new U;for(let s=0;s<t.length;s++)e.setChild(this._nodes[t[s]]);let s=this._skins.length>0?this._skins[0]:null,r=this._animations.length>0?this._animations:null;return e.traverse((t=>{t instanceof L&&(t.skeleton=s)})),[e,s,r]}}class et{constructor(t){this._debug=t,this._oldTimestamp=0,this._active=!1,this._onRender=()=>null}start(t){this._onRender=t,this._active=!0,requestAnimationFrame(this.run.bind(this))}stop(){this._active=!1}run(t){const e=performance.now(),s=(t-this._oldTimestamp)/1e3;this._oldTimestamp=t,this._onRender(s,t/1e3),null!==this._debug&&(this._debug.fps=1/s,this._debug.cpuTime=performance.now()-e),this._active&&requestAnimationFrame(this.run.bind(this))}}class st{constructor(t){t.addEventListener("keydown",this.bindKeyDown.bind(this)),t.addEventListener("keyup",this.bindKeyUp.bind(this)),this.any=!1,this.forward=!1,this.right=!1,this.back=!1,this.left=!1,this.shift=!1}bindKeyDown(t){switch(this.any=!0,t.code){case"KeyW":case"ArrowUp":this.forward=!0;break;case"KeyD":case"ArrowRight":this.right=!0;break;case"KeyS":case"ArrowDown":this.back=!0;break;case"KeyA":case"ArrowLeft":this.left=!0;break;case"ShiftLeft":this.shift=!0}}bindKeyUp(t){switch(this.any=!1,t.code){case"KeyW":case"ArrowUp":this.forward=!1;break;case"KeyD":case"ArrowRight":this.right=!1;break;case"KeyS":case"ArrowDown":this.back=!1;break;case"KeyA":case"ArrowLeft":this.left=!1;break;case"ShiftLeft":this.shift=!1}}}class rt{constructor(t){t.addEventListener("mouseup",this.mouseUp.bind(this)),t.addEventListener("mousemove",this.mouseMove.bind(this)),t.addEventListener("mousedown",this.mouseDown.bind(this)),t.addEventListener("wheel",this.mouseWheel.bind(this)),this._clicked=!1,this._scrolling=!1,this._offsetX=0,this._mouseOffsetX=0,this._lastMouseOffsetX=0,this._wheelOffset=0,this._mouseWheelOffset=0,this._lastMouseWheelOffset=0}update(){this._clicked&&(this._offsetX=this._mouseOffsetX-this._lastMouseOffsetX,this._lastMouseOffsetX=this._mouseOffsetX),this._scrolling=this._lastMouseWheelOffset!=this._mouseWheelOffset,this._scrolling&&(this._wheelOffset=this._mouseWheelOffset-this._lastMouseWheelOffset,this._lastMouseWheelOffset=this._mouseWheelOffset)}mouseDown(t){this._clicked=!0,this._lastMouseOffsetX=t.clientX}mouseUp(){this._clicked=!1}mouseMove(t){this._mouseOffsetX=t.clientX}mouseWheel(t){this._mouseWheelOffset+=t.deltaY}}let it=function(t){return t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT",t}({});class nt{_fov=45;_near=.1;_far=200;_zoomFactor=.01;_zoomMin=5;_zoomMax=40;_rotateFactor=.01;_projectionChanged=!0;_viewChanged=!0;_projectionViewChanged=!0;_orbit=!0;constructor(t,e,s){this._width=t.width,this._height=t.height,this._mouseInput=s,this._worldUp=p(0,1,0),this._position=e,this._target=p(0,0,0),this._projectionMatrix=n(),this._viewMatrix=n(),this._projectionViewMatrix=n(),this._direction=b(d(),T(d(),this._position,this._target)),this._followTarget=null,this._previousTargetPosition=null,this.screenPosition=null}update(t){if(this._orbit&&(M(this._position,this._position,this._target,.1*t),this.calculateViewMatrix()),this._mouseInput._scrolling){const t=d();E(t,this._direction,this._mouseInput._wheelOffset*this._zoomFactor);const e=g(d(),this._position,t),s=m(T(d(),e,this._target));s>this._zoomMin&&s<this._zoomMax&&(E(t,this._direction,this._mouseInput._wheelOffset*this._zoomFactor),this._position=e,b(this._direction,T(d(),this._position,this._target)),this.calculateViewMatrix())}if(this._mouseInput._clicked){const t=-this._mouseInput._offsetX*this._rotateFactor;M(this._position,this._position,this._target,t),this.calculateViewMatrix()}if(null!==this._followTarget&&null!==this._previousTargetPosition){const t=function(t){var e=new i(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}(this._followTarget.translation);t[1]=1.3;const e=t[0]-this._previousTargetPosition[0],s=t[2]-this._previousTargetPosition[2];this._position[0]+=e,this._position[2]+=s,this._target=t,this._previousTargetPosition=t,b(this._direction,T(d(),this._position,this._target)),this.calculateViewMatrix()}}follow(t){this._followTarget=t,this._previousTargetPosition=t.translation}get flatDirection(){return this._direction[1]=0,this._direction}get viewMatrix(){return this._viewChanged&&(f(this._viewMatrix,this._position,this._target,this._worldUp),this._viewChanged=!1),this._viewMatrix}get projectionMatrix(){return this._projectionChanged&&(_(this._projectionMatrix,this._fov,this._width/this._height,this._near,this._far),this._projectionChanged=!1),this._projectionMatrix}get projectionViewMatrix(){return this._projectionViewChanged&&(o(this._projectionViewMatrix,this.projectionMatrix,this.viewMatrix),this._projectionViewChanged=!1),this._projectionViewMatrix}calculateViewMatrix(){this._viewChanged=!0,this._projectionViewChanged=!0}calculateProjectionMatrix(){this._projectionChanged=!0,this._projectionViewChanged=!0}get rotY(){const t=u(x(),this.viewMatrix),e=Math.atan2(t[1],t[3]);return S(0,Math.sin(e),0,Math.cos(e))}get invertRotY(){return function(t,e){var s=e[0],r=e[1],i=e[2],n=e[3],a=s*s+r*r+i*i+n*n,o=a?1/a:0;return t[0]=-s*o,t[1]=-r*o,t[2]=-i*o,t[3]=n*o,t}(x(),this.rotY)}get width(){return this._width}get height(){return this._height}stopOrbiting(){this._orbit=!1}splitScreen(t){t!==it.TOP&&t!==it.BOTTOM||(this._height/=2,this.calculateProjectionMatrix()),t!==it.LEFT&&t!==it.RIGHT||(this._width/=2,this.calculateProjectionMatrix()),this.screenPosition=t}}class at{constructor(t){this._currentClip=null,this._clips={},this._time=null,this._speed=1,this._skeleton=t,this._fadeTargets=[],this._fadeParallel=!1,this._fadeTime=0,this._fadeDuration=.25}addClip(t,e){this._clips[t]=e}play(t){this._currentClip?.name!==t&&(this._currentClip=this._clips[t],this._time=null)}fadeTo(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._fadeTargets.length>0?this._fadeTargets[1]=this._clips[t]:(this._fadeTargets.push(this._clips[t]),this._fadeParallel=e)}update(t){if(null===this._currentClip)return;null===this._time&&(this._time=this._currentClip.startTime);const e=t*this._speed;this._time+=e,this._time>this._currentClip.endTime&&(this._time=Math.max(this._time%this._currentClip.duration,this._currentClip.startTime));let s=this._currentClip.sample(this._skeleton.bindPose,this._time);if(this._fadeTargets.length>0){this._fadeTime+=e;const t=this._fadeTargets[0];let r=this._fadeTime;if(this._fadeParallel&&(r=this._time/this._currentClip.duration*t.duration),this._fadeTime>this._fadeDuration)this._currentClip=this._fadeTargets.shift(),this._time=r,this._fadeTime=0,s=this._currentClip.sample(this._skeleton.bindPose,r);else{const e=this._fadeTime/this._fadeDuration,i=t.sample(this._skeleton.bindPose,r);s=s.blendTo(i,e)}}this._skeleton.currentPose.apply(s)}}class ot{constructor(){this._states={},this._currentState=null}addState(t,e){this._states[t]=e}setState(t){const e=this._currentState;if(e){if(e.name==t)return;e.exit()}const s=this._states[t];this._currentState=s,s.enter(e)}update(t){this._currentState&&this._currentState.update(t)}}class ht{}class lt extends ht{constructor(t){super(),this._parent=t}get name(){return"idle"}enter(t){null!==t?this._parent.animations.fadeTo("idle"):this._parent.animations.play("idle")}exit(){}update(){this._parent.moving&&this._parent.setState("walk")}}class ut extends ht{constructor(t){super(),this._parent=t}get name(){return"walk"}enter(t){t&&"idle"===t.name?this._parent.animations.fadeTo("walk"):this._parent.animations.fadeTo("walk",!0)}exit(){}update(){this._parent.moving||this._parent.running||this._parent.setState("idle"),this._parent.moving&&this._parent.running&&this._parent.setState("run")}}class ct extends ht{constructor(t){super(),this._parent=t}get name(){return"run"}enter(t){this._parent.animations.fadeTo("run",!0)}exit(){}update(){this._parent.moving?this._parent.running||this._parent.setState("walk"):this._parent.setState("idle")}}class _t extends ot{_acceleration=7;_deceleration=-4;_velocity=0;_rotationTime=.5;_currentRotationTime=0;_previousAngle=0;constructor(t,e,s,r){super(),this.animations=e,this._object=t,this._input=s,this._camera=r}static bind(t,e,s,r){const i=new _t(t,e,s,r);return i.addState("idle",new lt(i)),i.addState("walk",new ut(i)),i.addState("run",new ct(i)),i.setState("idle"),i}update(t){if(super.update(t),this.animations.update(t),!this.moving)return void(this._velocity=0);const e=p(0,0,1),s=p(0,0,0),i=this._camera.invertRotY;let n=this._velocity*this._deceleration;n*=t,n=Math.sign(n)*Math.min(Math.abs(n),Math.abs(this._velocity)),this._velocity=this._velocity+n,this._velocity+=this._acceleration*t,this._input.forward&&(s[2]=-1),this._input.right&&(s[0]=1),this._input.back&&(s[2]=1),this._input.left&&(s[0]=-1);const a=Math.atan2(s[0],s[2]),o=A(x(),i,a);var h,l,u,c,_,f,m,T,w,b;a!==this._previousAngle&&(this._currentRotationTime=0,this._previousAngle=a),h=this._object.rotation,l=o,u=h[0],c=h[1],_=h[2],f=h[3],m=l[0],T=l[1],w=l[2],b=l[3],Math.abs(u-m)<=r*Math.max(1,Math.abs(u),Math.abs(m))&&Math.abs(c-T)<=r*Math.max(1,Math.abs(c),Math.abs(T))&&Math.abs(_-w)<=r*Math.max(1,Math.abs(_),Math.abs(w))&&Math.abs(f-b)<=r*Math.max(1,Math.abs(f),Math.abs(b))||(this._currentRotationTime+=t,R(this._object.rotation,this._object.rotation,o,this._currentRotationTime/this._rotationTime),this._currentRotationTime>=this._rotationTime&&(this._object.rotation=o)),this.running&&E(e,e,2.8),function(t,e,s){var r=s[0],i=s[1],n=s[2],a=s[3],o=e[0],h=e[1],l=e[2],u=i*l-n*h,c=n*o-r*l,_=r*h-i*o,f=i*_-n*c,d=n*u-r*_,m=r*c-i*u,p=2*a;u*=p,c*=p,_*=p,f*=2,d*=2,m*=2,t[0]=o+u+f,t[1]=h+c+d,t[2]=l+_+m}(e,e,this._object.rotation),E(e,e,this._velocity*t),this._object.translation=g(d(),this._object.translation,e)}get moving(){return this._input.forward||this._input.right||this._input.back||this._input.left}get running(){return this._input.shift}get velocity(){return this._velocity}get previousAngle(){return this._previousAngle}}class ft extends U{_directions=[];constructor(){super(),this._intensity=1,this._directions=[{target:p(1,0,0),up:p(0,-1,0)},{target:p(-1,0,0),up:p(0,-1,0)},{target:p(0,1,0),up:p(0,0,1)},{target:p(0,-1,0),up:p(0,0,-1)},{target:p(0,0,1),up:p(0,-1,0)},{target:p(0,0,-1),up:p(0,-1,0)}]}update(t){}get projectionViewMatrix(){return n()}get faces(){return this._directions.length}get intensity(){return this._intensity}set intensity(t){this._intensity=t}getFaceProjectionViewMatrix(t){const e=f(n(),this.worldTranslation,g(d(),this.worldTranslation,this._directions[t].target),this._directions[t].up),s=_(n(),Math.PI/2,1,.1,20);return o(n(),s,e)}}class dt extends F{constructor(t,e){super(),this.vertex=t,this.fragment=e,this.uniforms=new Map}}class mt extends U{constructor(t,e){super(),this.geometry=t,this.material=e}}class pt extends mt{static create(t,e){const s=new dt(t.shader("fire_vertex"),t.shader("fire_fragment"));s.uniforms.set("u_resolution",[e.width,e.height]);const r=new N;return r.count=1,r.setEmptyAttribute("a_position",3,1),new pt(r,s.useBlending().disableShadows())}update(t,e){const s=e.velocity,r=e.previousAngle/Math.PI%1;let i=0;r<0?i=.25*s:r>0&&(i=.25*-s);const n=this.material;n.uniforms.set("u_time",t),n.uniforms.set("u_windFactor",i)}}class gt extends U{constructor(t,e){super(),this.geometry=t,this.material=e}}class Tt{constructor(){this.objects=[],this.drawables=[],this.light=null}addLight(t){return this.objects.push(t),this.light=t,this}add(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.objects.push(...e);for(let t=0;t<e.length;t++)e[t].traverse((t=>{t instanceof gt||t instanceof I||t instanceof mt?this.drawables.push(t):t instanceof ft&&(this.light=t)}));return this}updateMatrixWorld(){for(let t=0,e=this.objects.length;t<e;t++)this.objects[t].updateMatrixWorld()}traverse(t){for(let e=0,s=this.objects.length;e<s;e++)this.objects[e].traverse(t)}}function Et(){var t=new i(2);return i!=Float32Array&&(t[0]=0,t[1]=0),t}function wt(t,e){var s=new i(2);return s[0]=t,s[1]=e,s}function bt(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t}Et();class vt{static create(){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;const s=[],r=[],i=[],n=[],a=[],o=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:1)/2,h=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:1)/2,l=p(0,0,1),u=p(-o,h,0),c=p(-o,-h,0),_=p(o,-h,0),f=p(o,h,0),m=wt(0,1*e),g=wt(0,0),E=wt(1*t,0),w=wt(1*t,1*e);let b=T(d(),c,u),v=T(d(),_,u),M=bt(Et(),g,m),x=bt(Et(),E,m),y=1/(M[0]*x[1]-x[0]*M[1]);const A=d(),R=d();A[0]=y*(x[1]*b[0]-M[1]*v[0]),A[1]=y*(x[1]*b[1]-M[1]*v[1]),A[2]=y*(x[1]*b[2]-M[1]*v[2]),R[0]=y*(-x[0]*b[0]+M[0]*v[0]),R[1]=y*(-x[0]*b[1]+M[0]*v[1]),R[2]=y*(-x[0]*b[2]+M[0]*v[2]),b=T(d(),_,u),v=T(d(),f,u),M=bt(Et(),E,m),x=bt(Et(),w,m),y=1/(M[0]*x[1]-x[0]*M[1]);const C=d(),S=d();C[0]=y*(x[1]*b[0]-M[1]*v[0]),C[1]=y*(x[1]*b[1]-M[1]*v[1]),C[2]=y*(x[1]*b[2]-M[1]*v[2]),S[0]=y*(-x[0]*b[0]+M[0]*v[0]),S[1]=y*(-x[0]*b[1]+M[0]*v[1]),S[2]=y*(-x[0]*b[2]+M[0]*v[2]),s.push(...u),r.push(...l),i.push(...m),n.push(...A),a.push(...R),s.push(...c),r.push(...l),i.push(...g),n.push(...A),a.push(...R),s.push(..._),r.push(...l),i.push(...E),n.push(...A),a.push(...R),s.push(...u),r.push(...l),i.push(...m),n.push(...C),a.push(...S),s.push(..._),r.push(...l),i.push(...E),n.push(...C),a.push(...S),s.push(...f),r.push(...l),i.push(...w),n.push(...C),a.push(...S);const P=new N;return P.setAttribute("a_position",new Float32Array(s),3),P.setAttribute("a_normal",new Float32Array(r),3),P.setAttribute("a_uv",new Float32Array(i),2),P.setAttribute("a_tangents",new Float32Array(n),3),P.setAttribute("a_bitangents",new Float32Array(a),3),P.count=s.length/3,P}}const Mt=20;class xt{constructor(t){this._tiles=[];for(let e=0;e<3;e++)for(let s=0;s<3;s++){const r=new I(vt.create(Mt,Mt,2,2),(new F).setImage(t.image("ground"),!0).setNormal(t.image("ground_normal"),!0));r.rotation=y(x(),r.rotation,-Math.PI/2),r.translation=p(Mt*e-20,0,Mt*s-20),this._tiles.push(r)}this._playerConstraintsX=[-10,10],this._playerConstraintsZ=[-10,10]}update(t){if(this.withinConstraints(t))return;let e=null;for(let s=0;s<this._tiles.length;s++)null===e&&(e=this._tiles[s].translation),w(t,this._tiles[s].translation)<w(t,e)&&(e=this._tiles[s].translation);if(null===e)throw new Error("Nearest point cannot be calculated.");for(let t=0,s=0;s<3;s++)for(let r=0;r<3;r++,t++){const i=p(Mt*s-20,0,Mt*r-20);g(i,i,e),this._tiles[t].translation=i}this._playerConstraintsX=[e[0]-10,e[0]+10],this._playerConstraintsZ=[e[2]-10,e[2]+10]}get tiles(){return this._tiles}withinConstraints(t){return!(t[0]<this._playerConstraintsX[0]||t[0]>this._playerConstraintsX[1]||t[2]<this._playerConstraintsZ[0]||t[2]>this._playerConstraintsZ[1])}}class yt{_nextValue=0;_currentValue=0;_previousValue=0;_t=0;constructor(t,e,s){this._value=t,this._previousValue=t,this._currentValue=t,this._frequency=e,this._amplitude=s}update(t){this._t+=t*this._frequency,this._t>=1&&(this._previousValue=this._nextValue,this._nextValue=this._value+(Math.random()*(this._amplitude- -this._amplitude)-this._amplitude),this._t=0),this._currentValue=this._lerp(this._previousValue,this._nextValue,this._t)}get value(){return this._currentValue}set value(t){this._value=t}_lerp(t,e,s){return t*(1-s)+e*s}}class At{static create(t){let e=3735928559,s=1103547991;for(let r,i=0,n=t.length;i<n;i++)r=t.charCodeAt(i),e=Math.imul(e^r,2654435761),s=Math.imul(s^r,1597334677);return e=Math.imul(e^e>>>16,2246822507),e^=Math.imul(s^s>>>13,3266489909),s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(e^e>>>13,3266489909),4294967296*(2097151&s)+(e>>>0)}}class Rt{constructor(t,e,s,r,i){this._gl=t,this._name=e,this._location=s,this._type=r,this._size=i}set(t){switch(this._type){case 35676:this._gl.uniformMatrix4fv(this._location,!1,t);break;case 35675:this._gl.uniformMatrix3fv(this._location,!1,t);break;case 35665:this._gl.uniform3fv(this._location,t);break;case 35678:case 35680:case 5124:case 35682:case 36293:this._gl.uniform1i(this._location,t);break;case 5126:this._gl.uniform1f(this._location,t);break;case 35666:this._gl.uniform4fv(this._location,t);break;case 35664:this._gl.uniform2fv(this._location,t);break;default:throw new Error(`Cannot set uniform value - unrecognized type "${this._type}".`)}}}class Ct{constructor(){this._uniforms=new Map}static create(t,e){const s=new this,r=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let i=0;i<r;++i){const r=t.getActiveUniform(e,i),n=t.getUniformLocation(e,r.name);let a=r.name;a.endsWith("[0]")&&(a=a.slice(0,-3)),s._uniforms.set(a,new Rt(t,a,n,r.type,r.size))}return s}get(t){if(!this._uniforms.has(t))throw new Error(`Program doesn't have "${t}" uniform.`);return this._uniforms.get(t)}has(t){return this._uniforms.has(t)}}class St{constructor(t,e,s){this.location=s,this._gl=t,this._name=e}set(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._gl.ARRAY_BUFFER;const s=this._gl,r=s.createBuffer();if(null===r)throw new Error("Cannot create webgl buffer.");const i=(()=>{switch(!0){case t.data instanceof Int8Array:return s.BYTE;case t.data instanceof Uint8Array:return s.UNSIGNED_BYTE;case t.data instanceof Int16Array:return s.SHORT;case t.data instanceof Uint16Array:return s.UNSIGNED_SHORT;case t.data instanceof Int32Array:return s.INT;case t.data instanceof Uint32Array:return s.UNSIGNED_INT;case t.data instanceof Float32Array:return s.FLOAT;default:throw new Error("Cannot infer data type from array.")}})();s.bindBuffer(e,r),s.bufferData(e,t.data,s.STATIC_DRAW),s.enableVertexAttribArray(this.location),s.vertexAttribPointer(this.location,t.itemSize,i,t.normalized,0,0),s.bindBuffer(e,null)}}class Pt{constructor(t){this._gl=t,this._attributes=new Map}static create(t,e){const s=new this(t),r=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let i=0;i<r;++i){const r=t.getActiveAttrib(e,i),n=t.getAttribLocation(e,r.name);s._attributes.set(r.name,new St(t,r.name,n))}return s}get(t){if(!this.has(t))throw new Error(`Program doesn't have "${t}" attribute.`);return this._attributes.get(t)}has(t){return this._attributes.has(t)}setInterleaved(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._gl.ARRAY_BUFFER,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this._gl.STATIC_DRAW;const i=this._gl,n=i.createBuffer();if(null===n)throw new Error("Cannot create webgl buffer.");const a=(()=>{switch(!0){case t instanceof Int8Array:return i.BYTE;case t instanceof Uint8Array:return i.UNSIGNED_BYTE;case t instanceof Int16Array:return i.SHORT;case t instanceof Uint16Array:return i.UNSIGNED_SHORT;case t instanceof Int32Array:return i.INT;case t instanceof Uint32Array:return i.UNSIGNED_INT;case t instanceof Float32Array:return i.FLOAT;default:throw new Error("Cannot infer data type from array.")}})();i.bindBuffer(s,n),i.bufferData(s,t,r);let o=0;for(let s=0,r=e.length;s<r;s++)o+=t.BYTES_PER_ELEMENT*e[s].itemSize;let h=0;for(let s=0,r=e.length;s<r;s++){const r=e[s];if(this.has(r.name)){const e=this.get(r.name).location;console.log(e,r.itemSize,a,r.normalized),i.enableVertexAttribArray(e),i.vertexAttribPointer(e,r.itemSize,a,r.normalized,0,0),h+=t.BYTES_PER_ELEMENT*r.itemSize}}return i.bindBuffer(s,null),n}}class Ut{static create(t,e,s){const r=t.createShader(e);if(null===r)throw new Error("Cannot create webgl shader.");if(t.shaderSource(r,s),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(`Unexpected error while compiling ${e===t.VERTEX_SHADER?"vertex":"fragment"} shader: `+t.getShaderInfoLog(r));return r}}class It{constructor(t,e){this._gl=t,this._program=e,this._cachedUniforms=null,this._cachedAttributes=null}static create(t,e,s){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];const i=t.createProgram();if(null===i)throw new Error("Cannot create webgl program.");const n=Ut.create(t,t.VERTEX_SHADER,e),a=Ut.create(t,t.FRAGMENT_SHADER,s);if(t.attachShader(i,n),t.attachShader(i,a),r.length>0&&t.transformFeedbackVaryings(i,r,t.INTERLEAVED_ATTRIBS),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error("Unexpected error while creating a program. "+t.getProgramInfoLog(i));return new this(t,i)}get attributes(){return null===this._cachedAttributes&&(this._cachedAttributes=Pt.create(this._gl,this._program)),this._cachedAttributes}get uniforms(){return null===this._cachedUniforms&&(this._cachedUniforms=Ct.create(this._gl,this._program)),this._cachedUniforms}useProgram(){this._gl.useProgram(this._program)}stopProgram(){this._gl.useProgram(null)}}class Lt extends U{_projectionChanged=!0;_viewChanged=!0;_projectionViewChanged=!0;constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:p(0,0,0);super(),this._currentTarget=t,this._followTarget=null,this._previousFollowTargetPosition=null,this._worldUp=[0,1,0],this._projectionMatrix=n(),this._viewMatrix=n(),this._projectionViewMatrix=n()}update(t){if(null===this._followTarget||null===this._previousFollowTargetPosition)return;const e=this._followTarget.translation;var s,i,n,a,o,h,l,u;i=e,n=(s=this._previousFollowTargetPosition)[0],a=s[1],o=s[2],h=i[0],l=i[1],u=i[2],Math.abs(n-h)<=r*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(a-l)<=r*Math.max(1,Math.abs(a),Math.abs(l))&&Math.abs(o-u)<=r*Math.max(1,Math.abs(o),Math.abs(u))||(this.translation=p(e[0],5,e[2]+5),this._currentTarget=this._followTarget.translation,this._viewChanged=!0,this._projectionViewChanged=!0,this._previousFollowTargetPosition=e)}follow(t){this._followTarget=t,this._previousFollowTargetPosition=t.translation}get projectionViewMatrix(){return this._projectionViewChanged&&(o(this._projectionViewMatrix,this.orthographicProjectionMatrix,this.viewMatrix),this._projectionViewChanged=!1),this._projectionViewMatrix}get viewMatrix(){return this._viewChanged&&(f(this._viewMatrix,this.translation,this._currentTarget,this._worldUp),this._viewChanged=!1),this._viewMatrix}get perspectiveProjectionMatrix(){return this._projectionChanged&&(_(this._projectionMatrix,60*Math.PI/180,1,1,30),this._projectionChanged=!1),this._projectionMatrix}get orthographicProjectionMatrix(){return this._projectionChanged&&(function(t,e,s,r,i,n,a){var o=1/(e-s),h=1/(r-i),l=1/(n-a);t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+s)*o,t[13]=(i+r)*h,t[14]=(a+n)*l,t[15]=1}(this._projectionMatrix,-2,2,-2,2,0,10),this._projectionChanged=!1),this._projectionMatrix}}class Ot{constructor(t){this._shaderCache=t,this._programs=new Map,this._depthPrograms=new Map}fromMaterial(t,e,s,r){if(s instanceof dt)return this.fromShader(t,s.vertex,s.fragment);const i=[];i.push(s.image?"#define USE_TEXTURE":""),i.push(s.vertexColors?"#define USE_COLOR_ATTRIBUTE":""),i.push(s.color?"#define USE_STATIC_COLOR_ATTRIBUTE":""),i.push(s.normal?"#define USE_NORMAL_MAPPING":""),i.push(r instanceof Lt?"#define USE_LIGHT_DIRECTIONAL":""),i.push(r instanceof ft?"#define USE_LIGHT_POINT":""),i.push(r instanceof Lt||r instanceof ft?"#define USE_LIGHT":""),e instanceof L&&i.push("#define USE_SKINNING");const n=At.create(i.join(""));if(this._programs.has(n))return this._programs.get(n);const a=It.create(t,this._shaderCache.getVertex(i),this._shaderCache.getFragment(i));return this._programs.set(n,a),a}fromShader(t,e,s){const r=At.create(e+s);if(this._programs.has(r))return this._programs.get(r);const i=It.create(t,e,s);return this._programs.set(r,i),i}depthPass(t,e){let s=[];e instanceof L&&s.push("#define USE_SKINNING");const r=At.create(s.join(""));if(this._depthPrograms.has(r))return this._depthPrograms.get(r);const i=It.create(t,this._shaderCache.getDepthVertex(s),this._shaderCache.getDepthFragment(s));return this._depthPrograms.set(r,i),i}}class Ft{constructor(){this._textures=new Map}set(t,e,s){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.LINEAR,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:t.CLAMP_TO_EDGE;const n=t.createTexture();if(null===n)throw new Error("Cannot create webgl texture.");t.bindTexture(t.TEXTURE_2D,n),null!==s&&(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,s),t.generateMipmap(t.TEXTURE_2D)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,i),this._textures.set(e,n),t.bindTexture(t.TEXTURE_2D,null)}has(t){return this._textures.has(t)}get(t){if(!this.has(t))throw new Error(`Texture with name "${t}" doesn't exists.`);return this._textures.get(t)}}class Dt{constructor(){this._vaos=new Map}bind(t,e){let s=this._vaos.get(e)??null;if(null===s&&(s=t.createVertexArray()),null===s)throw new Error("Cannot create vertex attribute array.");this._vaos.set(e,s),t.bindVertexArray(s)}unbind(t){t.bindVertexArray(null)}}const Bt="#version 300 es";class Nt{constructor(t){this._assets=t}getVertex(t){return`${Bt}\n        \n        ${t.join("\n")}\n        \n        ${this._assets.shader("default_vertex")}\n        `}getFragment(t){return`${Bt}\n        \n        ${t.join("\n")}\n        \n        ${this._assets.shader("default_fragment")}\n        `}getDepthVertex(t){return`${Bt}\n            \n        ${t.join("\n")}\n    \n        ${this._assets.shader("depth_vertex")}\n        `}getDepthFragment(t){return`${Bt}\n                \n        ${t.join("\n")}\n\n        ${this._assets.shader("depth_fragment")}\n        `}}class jt{static textureSize=256;constructor(t,e){this.depthTexture=t,this.depthFramebuffer=e}static depth(t){const e=t.createTexture(),s=t.createFramebuffer();if(null===e)throw new Error("Cannot create framebuffer depth texture.");if(null===s)throw new Error("Cannot create framebuffer.");return t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT16,this.textureSize,this.textureSize,0,t.DEPTH_COMPONENT,t.UNSIGNED_SHORT,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_MODE,t.COMPARE_REF_TO_TEXTURE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_FUNC,t.LEQUAL),t.bindFramebuffer(t.FRAMEBUFFER,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,e,0),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null),new this(e,s)}static cubeDepth(t){const e=t.createTexture(),s=t.createFramebuffer();if(null===e)throw new Error("Cannot create framebuffer depth texture.");if(null===s)throw new Error("Cannot create framebuffer.");t.bindTexture(t.TEXTURE_CUBE_MAP,e),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_R,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_COMPARE_MODE,t.COMPARE_REF_TO_TEXTURE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_COMPARE_FUNC,t.LEQUAL);for(let e=0;e<6;e++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,t.DEPTH_COMPONENT16,this.textureSize,this.textureSize,0,t.DEPTH_COMPONENT,t.UNSIGNED_SHORT,null);return t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_CUBE_MAP,null),new this(e,s)}passDirection(t,e){return[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z][e]}}window.addEventListener("error",(t=>alert(t.message)));const Xt=new class{constructor(t){this._window=t}find(t){return this._window.document.querySelector(t)}addEventListener(t,e){this._window.document.addEventListener(t,e)}get searchParams(){return new URLSearchParams(this._window.location.search)}get debug(){return this.searchParams.has("debug")}get body(){return this._window.document.body}}(window),kt=Xt.debug?class{_updateInterval=3;_samplesCount=60;_fpsSamples=[];_cpuTimeSamples=[];_gpuTimeSamples=[];_active=!1;_lastUpdate=this._updateInterval;constructor(t,e,s,r,i,n){this._fpsElement=t,this._cpuTimeElement=e,this._gpuTimeElement=s,this._jsHeapUsedElement=r,this._jsHeapLimitElement=i,this._jsHeapAvailableElement=n}static create(t){const e=t.find("[data-debug-container]"),s=t.find("[data-toggle-debug-container]"),r=new this(e.querySelector("[data-fps-counter]"),e.querySelector("[data-ms-cpu-counter]"),e.querySelector("[data-ms-gpu-counter]"),e.querySelector("[data-heap-used]"),e.querySelector("[data-heap-limit]"),e.querySelector("[data-heap-available]"));return s.addEventListener("click",(()=>r._active=e.classList.toggle("active"))),s.classList.add("initialized"),r}update(t){if(!this._active)return;if(this._lastUpdate+=t,this._lastUpdate<this._updateInterval)return;this._fpsElement.textContent=Math.round(this.averageFrom(this._fpsSamples)).toString(),this._cpuTimeElement.textContent=this.averageFrom(this._cpuTimeSamples).toFixed(2).concat(" ms"),this._gpuTimeElement.textContent=this.averageFrom(this._gpuTimeSamples).toFixed(2).concat(" ms");const e=window.performance.memory;void 0!==e&&(this._jsHeapLimitElement.textContent=Math.round(e.jsHeapSizeLimit/1e6).toString().concat(" MB"),this._jsHeapAvailableElement.textContent=Math.round(e.totalJSHeapSize/1e6).toString().concat(" MB"),this._jsHeapUsedElement.textContent=Math.round(e.usedJSHeapSize/1e6).toString().concat(" MB")),this._lastUpdate=0}set fps(t){this._fpsSamples.push(t),this._fpsSamples.length>=this._samplesCount&&this._fpsSamples.shift()}set cpuTime(t){this._cpuTimeSamples.push(t),this._cpuTimeSamples.length>=this._samplesCount&&this._cpuTimeSamples.shift()}set gpuTime(t){this._gpuTimeSamples.push(t),this._gpuTimeSamples.length>=this._samplesCount&&this._gpuTimeSamples.shift()}averageFrom(t){if(0===t.length)return 0;let e=0;for(let s=0;s<t.length;s++)e+=t[s];return e/t.length}}.create(Xt):null,Vt=new class{_assetsCount=0;_assetsLoaded=0;constructor(){this._afterLoad=()=>{},this._queue=[],this._shaders=new Map,this._images=new Map,this._models=new Map}load(t){this._afterLoad=t,this._queue.forEach((t=>t()))}importShader(t,e){this._assetsCount++,this._queue.push((()=>fetch(e).then((t=>t.text())).then((e=>{this._shaders.set(t,e),this._assetsLoaded++,this.checkAssets()})).catch((t=>{throw new Error(t)}))))}importImage(t,e){this._assetsCount++,this._queue.push((()=>{const s=new Image;s.onload=()=>{this._images.set(t,s),this._assetsLoaded++,this.checkAssets()},s.src=e}))}importModel(t,e){this._assetsCount++,this._queue.push((()=>fetch(e).then((t=>t.json())).then((t=>tt.parse(t))).then((e=>{this._models.set(t,e),this._assetsLoaded++,this.checkAssets()})).catch((t=>{throw new Error(t)}))))}importBinaryModel(t,e){this._assetsCount++,this._queue.push((()=>fetch(e).then((t=>t.arrayBuffer())).then((t=>tt.parseBinary(t))).then((e=>{this._models.set(t,e),this._assetsLoaded++,this.checkAssets()})).catch((t=>{throw new Error(t)}))))}shader(t){if(!this._shaders.has(t))throw new Error(`Shader "${t}" not found in assets.`);return this._shaders.get(t)}image(t){if(!this._images.has(t))throw new Error(`Image "${t}" not found in assets.`);return this._images.get(t)}model(t){if(!this._models.has(t))throw new Error(`Model "${t}" not found in assets.`);return this._models.get(t)}checkAssets(){this._assetsLoaded===this._assetsCount&&this._afterLoad()}},Gt=new class{_vertexArrays=new Dt;_textures=new Ft;constructor(t,e,s){if(this._canvas=t.find("canvas"),this._gl=this._canvas.getContext("webgl2",{powerPreference:"high-performance",antialias:!0}),null===this._gl)throw new Error("Unsupported browser or a device: WebGL 2 is unavailable.");this._debug=s,this._shaderCache=new Nt(e),this._programs=new Ot(this._shaderCache),this._framebuffer=null,this._query=null,this._queryExt=null,this._canvas.width=this._canvas.offsetWidth,this._canvas.style.width=`${this._canvas.offsetWidth}px`,this._canvas.height=this._canvas.offsetHeight,this._canvas.style.height=`${this._canvas.offsetHeight}px`,this._gl.enable(this._gl.DEPTH_TEST),this._gl.enable(this._gl.CULL_FACE),null!==this._debug&&(this._queryExt=this._gl.getExtension("EXT_disjoint_timer_query_webgl2"))}render(t,e){const s=this._gl,r=this._canvas.width,i=this._canvas.height;if(t.updateMatrixWorld(),null!==this._queryExt){if(null!==this._query){let t=s.getQueryParameter(this._query,s.QUERY_RESULT_AVAILABLE),e=s.getParameter(this._queryExt.GPU_DISJOINT_EXT);if(t&&!e){const t=s.getQueryParameter(this._query,s.QUERY_RESULT);this._debug.gpuTime=1e-6*t}}else this._query=s.createQuery();s.beginQuery(this._queryExt.TIME_ELAPSED_EXT,this._query)}if(null!==t.light){if(s.enable(s.POLYGON_OFFSET_FILL),s.polygonOffset(1,10),t.light instanceof Lt&&(null===this._framebuffer&&(this._framebuffer=jt.depth(s)),this.renderToFramebuffer(t,t.light.projectionViewMatrix)),t.light instanceof ft){null===this._framebuffer&&(this._framebuffer=jt.cubeDepth(s));for(let e=0;e<t.light.faces;e++)this.renderToFramebuffer(t,t.light.getFaceProjectionViewMatrix(e),e)}s.disable(s.POLYGON_OFFSET_FILL)}null!==e.screenPosition?(s.enable(s.SCISSOR_TEST),it.TOP===e.screenPosition&&(s.viewport(0,i/2,r,i/2),s.scissor(0,i/2,r,i/2)),it.BOTTOM===e.screenPosition&&(s.viewport(0,0,r,i/2),s.scissor(0,0,r,i/2)),it.LEFT===e.screenPosition&&(s.viewport(0,0,r/2,i),s.scissor(0,0,r/2,i)),it.RIGHT===e.screenPosition&&(s.viewport(r/2,0,r/2,i),s.scissor(r/2,0,r/2,i))):s.viewport(0,0,r,i);for(let r=0,i=t.drawables.length;r<i;r++)this.renderObject(s,t.drawables[r],e,t.light);null!==e.screenPosition&&s.disable(s.SCISSOR_TEST),null!==this._queryExt&&s.endQuery(this._queryExt.TIME_ELAPSED_EXT)}renderObject(t,e,s,r){const i=e.geometry,a=e.material,o=this._programs.fromMaterial(t,e,a,r);if(o.useProgram(),this._vertexArrays.bind(t,i.id),i.updateBuffers){for(let t=0,e=i.attributes.length;t<e;t++){const e=i.attributes[t];o.attributes.has(e.name)&&o.attributes.get(e.name).set(e)}if(i.indexed){const e=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e),t.bufferData(t.ELEMENT_ARRAY_BUFFER,i.index,t.STATIC_DRAW)}i.updateBuffers=!1}if(o.uniforms.get("u_projectionView").set(s.projectionViewMatrix),o.uniforms.get("u_model").set(e.worldTransform),null!==e.material.image&&(this._textures.has(e.material.image.src)||this._textures.set(t,e.material.image.src,e.material.image,t.LINEAR,e.material.imageRepeat?t.REPEAT:t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this._textures.get(e.material.image.src)),o.uniforms.get("u_texture").set(1)),null!==e.material.normal&&o.uniforms.has("u_textureNormal")&&(this._textures.has(e.material.normal.src)||this._textures.set(t,e.material.normal.src,e.material.normal,t.LINEAR,e.material.normalRepeat?t.REPEAT:t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,this._textures.get(e.material.normal.src)),o.uniforms.get("u_textureNormal").set(2)),o.uniforms.has("u_depthTexture")&&this._framebuffer?.depthTexture&&(t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,this._framebuffer.depthTexture),o.uniforms.get("u_depthTexture").set(3)),o.uniforms.has("u_depthCubeMapTexture")&&this._framebuffer?.depthTexture&&(t.activeTexture(t.TEXTURE4),t.bindTexture(t.TEXTURE_CUBE_MAP,this._framebuffer.depthTexture),o.uniforms.get("u_depthCubeMapTexture").set(4)),r&&o.uniforms.has("u_lightPosition")&&o.uniforms.get("u_lightPosition").set(r.worldTranslation),r instanceof ft&&o.uniforms.has("u_lightIntensity")&&o.uniforms.get("u_lightIntensity").set(r.intensity),r&&o.uniforms.has("u_lightProjectionViewMatrix")&&o.uniforms.get("u_lightProjectionViewMatrix").set(r.projectionViewMatrix),o.uniforms.has("u_cameraPosition")&&o.uniforms.get("u_cameraPosition").set(s._position),o.uniforms.has("u_normalMatrix")){const t=n();!function(t,e){var s=e[0],r=e[1],i=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],u=e[8],c=e[9],_=e[10],f=e[11],d=e[12],m=e[13],p=e[14],g=e[15],T=s*o-r*a,E=s*h-i*a,w=s*l-n*a,b=r*h-i*o,v=r*l-n*o,M=i*l-n*h,x=u*m-c*d,y=u*p-_*d,A=u*g-f*d,R=c*p-_*m,C=c*g-f*m,S=_*g-f*p,P=T*S-E*C+w*R+b*A-v*y+M*x;P&&(P=1/P,t[0]=(o*S-h*C+l*R)*P,t[1]=(i*C-r*S-n*R)*P,t[2]=(m*M-p*v+g*b)*P,t[3]=(_*v-c*M-f*b)*P,t[4]=(h*A-a*S-l*y)*P,t[5]=(s*S-i*A+n*y)*P,t[6]=(p*w-d*M-g*E)*P,t[7]=(u*M-_*w+f*E)*P,t[8]=(a*C-o*A+l*x)*P,t[9]=(r*A-s*C-n*x)*P,t[10]=(d*v-m*w+g*T)*P,t[11]=(c*w-u*v-f*T)*P,t[12]=(o*y-a*R-h*x)*P,t[13]=(s*R-r*y+i*x)*P,t[14]=(m*E-d*b-p*T)*P,t[15]=(u*b-c*E+_*T)*P)}(t,e.worldTransform),function(t,e){if(t===e){var s=e[1],r=e[2],i=e[3],n=e[6],a=e[7],o=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=s,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=n,t[11]=e[14],t[12]=i,t[13]=a,t[14]=o}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]}(t,t),o.uniforms.get("u_normalMatrix").set(t)}if(e instanceof L){const s=`skin_${e.geometry.id}`;this._textures.has(s)||this._textures.set(t,s,null,t.NEAREST,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE5),t.bindTexture(t.TEXTURE_2D,this._textures.get(s)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,4,e.skeleton.jointCount,0,t.RGBA,t.FLOAT,e.skeleton.jointMatrix),o.uniforms.get("u_jointTexture").set(5)}null!==e.material.color&&o.uniforms.get("u_color").set(e.material.color),e.material instanceof dt&&e.material.uniforms.forEach((function(t,e){o.uniforms.has(e)&&o.uniforms.get(e).set(t)}));let h=null;if(e instanceof gt&&(h=t.LINES),e instanceof I&&(h=t.TRIANGLES),e instanceof mt&&(h=t.POINTS),null===h)throw new Error("Cannot get rendering mode.");e.material.blending&&(t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE)),i.indexed?t.drawElements(h,i.count,t.UNSIGNED_SHORT,0):t.drawArrays(h,0,i.count),e.material.blending&&(t.blendFunc(t.SRC_ALPHA,t.ZERO),t.enable(t.DEPTH_TEST)),this._vertexArrays.unbind(t),o.stopProgram()}renderToFramebuffer(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(null===this._framebuffer)throw new Error("Framebuffer should be initialized before rendering to framebuffer.");const r=this._gl;r.bindFramebuffer(r.FRAMEBUFFER,this._framebuffer.depthFramebuffer),null!==s&&r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,this._framebuffer.passDirection(r,s),this._framebuffer.depthTexture,0),r.viewport(0,0,jt.textureSize,jt.textureSize),r.clear(r.DEPTH_BUFFER_BIT);for(let s=0,i=t.drawables.length;s<i;s++){const i=t.drawables[s];if(!i.material.castShadow)continue;const n=i.geometry,a=this._programs.depthPass(r,i);if(a.useProgram(),this._vertexArrays.bind(r,n.id),n.updateBuffers&&n.indexed){const t=r.createBuffer();r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),r.bufferData(r.ELEMENT_ARRAY_BUFFER,n.index,r.STATIC_DRAW)}if(i instanceof L){const t=`skin_${i.geometry.id}`;this._textures.has(t)||this._textures.set(r,t,null,r.NEAREST,r.CLAMP_TO_EDGE),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._textures.get(t)),r.texImage2D(r.TEXTURE_2D,0,r.RGBA32F,4,i.skeleton.jointCount,0,r.RGBA,r.FLOAT,i.skeleton.jointMatrix),a.uniforms.get("u_jointTexture").set(0)}a.uniforms.get("u_model").set(i.worldTransform),a.uniforms.get("u_lightSpace").set(e);let o=null;if(i instanceof gt&&(o=r.LINES),i instanceof I&&(o=r.TRIANGLES),i instanceof mt&&(o=r.POINTS),null===o)throw new Error("Cannot get rendering mode.");n.indexed?r.drawElements(o,n.count,r.UNSIGNED_SHORT,0):r.drawArrays(o,0,n.count),this._vertexArrays.unbind(r),a.stopProgram()}r.bindFramebuffer(r.FRAMEBUFFER,null)}get canvas(){return this._canvas}}(Xt,Vt,kt),Ht=new class{constructor(t,e,s,r){this._assets=e,this._debug=r,this._loop=new et(r),this._renderer=s,this._keyboard=new st(t),this._mouse=new rt(t)}bootstrap(){const t=new nt(this._renderer.canvas,p(0,4.5,4.5),this._mouse),e=new xt(this._assets),[s]=this._assets.model("torch").scene;s.translation=p(0,-.05,0),s.rotation=A(x(),x(),Math.PI/2);const[r,i,n]=this._assets.model("akai").scene;r.rotation=A(x(),x(),.7),i?.getBone(31).setChild(s),t.follow(r);const a=new at(i);a.addClip("idle",n[0]),a.addClip("walk",n[2]),a.addClip("run",n[1]);const o=_t.bind(r,a,this._keyboard,t),h=new ft;h.translation=p(0,.8,.2),s.setChild(h);const l=new yt(.9,4,.15),u=new yt(h.translation[1],4,.1),c=pt.create(this._assets,t);s.setChild(c),c.translation=p(0,.58,0);const _=new Tt;_.addLight(h),_.add(...e.tiles),_.add(r),_.add(c),this._loop.start(((s,i)=>{this._keyboard.any&&t.stopOrbiting(),this._mouse.update(),t.update(s),o.update(s),e.update(r.translation),_.light?.update(s),_.light instanceof ft&&(l.update(s),u.update(s),_.light.intensity=l.value,_.light.translation=p(h.translation[0],u.value,h.translation[2])),c.update(i,o),this._renderer.render(_,t),this._debug?.update(s)}))}}(Xt,Vt,Gt,kt);Vt.importShader("default_vertex","shader/default/vertex.glsl"),Vt.importShader("default_fragment","shader/default/fragment.glsl"),Vt.importShader("depth_vertex","shader/depth/vertex.glsl"),Vt.importShader("depth_fragment","shader/depth/fragment.glsl"),Vt.importShader("fire_vertex","shader/particle/fire/vertex.glsl"),Vt.importShader("fire_fragment","shader/particle/fire/fragment.glsl"),Vt.importImage("ground","image/ground.jpg"),Vt.importImage("ground_normal","image/ground_normal.jpg"),Vt.importBinaryModel("akai","model/akai.glb"),Vt.importBinaryModel("torch","model/torch.glb"),Xt.addEventListener("DOMContentLoaded",(()=>{Vt.load((()=>{Ht.bootstrap(),Xt.body.classList.add("initialized")}))}))}();